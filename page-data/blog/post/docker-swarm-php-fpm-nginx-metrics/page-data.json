{"componentChunkName":"component---src-templates-post-template-js","path":"/blog/post/docker-swarm-php-fpm-nginx-metrics","result":{"data":{"markdownRemark":{"id":"eecdeb6a-558b-519b-b59f-aa15364e12ba","html":"<h3 id=\"научимся-собирать-метрики-php-fpm-и-nginx-на-основе-status-page-при-помощи-datadog-в-сети-docker-swarm\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%83%D1%87%D0%B8%D0%BC%D1%81%D1%8F-%D1%81%D0%BE%D0%B1%D0%B8%D1%80%D0%B0%D1%82%D1%8C-%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA%D0%B8-php-fpm-%D0%B8-nginx-%D0%BD%D0%B0-%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%B5-status-page-%D0%BF%D1%80%D0%B8-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D0%B8-datadog-%D0%B2-%D1%81%D0%B5%D1%82%D0%B8-docker-swarm\" aria-label=\"научимся собирать метрики php fpm и nginx на основе status page при помощи datadog в сети docker swarm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Научимся собирать метрики php-fpm и nginx, на основе status page при помощи Datadog в сети Docker Swarm</h3>\n<hr>\n<p>Серия статей</p>\n<ol>\n<li><a href=\"/posts/create-docker-network-for-datadog\">Создаём защищённую сеть в Docker Swarm для внутренних сервисов на примере Datadog</a></li>\n<li><a href=\"/posts/connect-datadog-apm-to-docker-swarm\">Настраиваем Datadog APM в сети Docker Swarm</a></li>\n<li><strong>Собираем метрики php-fpm и nginx при помощи Datadog в сети Docker Swarm</strong></li>\n<li><a href=\"/posts/datadog-monitor-slack-notifications\">Мониторим метрики при помощи Datadog Monitor и отправляем нотификации в Slack при возникновении проблем</a></li>\n</ol>\n<p>Кроме APM при помощи datadog мы можем собирать метрики: периодически опрашивать состояние заданных сервисов.</p>\n<p>Это очень полезный инструмент для мониторинга состояния ресурса, который позволяет снизить время реакции команды\nпри различных отклонениях в работе сервиса.</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/heartbeat.jpg\" alt=\"Heartbeat\" title=\"Heartbeat\"></p>\n<h1 id=\"настройка-интеграции-php-fpm\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8-php-fpm\" aria-label=\"настройка интеграции php fpm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка интеграции php-fpm</h1>\n<p>Для получения метрик php-fpm datadog’у необходим доступ к\nphp-fpm <a href=\"https://www.tecmint.com/enable-monitor-php-fpm-status-in-nginx/\">status page</a>.</p>\n<p>Нам необходимо настроить php-fpm и nginx так, чтобы можно было получить эту страницу <em>только</em> из нашей служебной сети и\nуказать путь к ней datadog’у. Далее datadog будет периодически получать состояние с этой страницы.</p>\n<h2 id=\"интеграция-datadog\" style=\"position:relative;\"><a href=\"#%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F-datadog\" aria-label=\"интеграция datadog permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Интеграция Datadog</h2>\n<p>В первую очередь зайдём в Datadog > Integrations, введем в поиске php-fpm и установим интеграцию.\nДолжно выглядеть примерно так:</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/datadog-php-fpm-integration.png\" alt=\"Docker php-fpm Integration\" title=\"Docker php-fpm Integration\"></p>\n<p>Во вкладке <code>Configuration</code> можно найти краткое описание процесса настройки. </p>\n<h2 id=\"настройка-контейнеров\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%BE%D0%B2\" aria-label=\"настройка контейнеров permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка контейнеров</h2>\n<h3 id=\"php-fpm\" style=\"position:relative;\"><a href=\"#php-fpm\" aria-label=\"php fpm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>php-fpm</h3>\n<p>Чтобы php-fpm отдавал служебные страницы о состоянии, необходимо указать соответствующие аттрибуты\nв <a href=\"https://www.php.net/manual/ru/install.fpm.configuration.php\">файле конфигурации</a></p>\n<h4 id=\"копирование-файла-конфигурации-php-fpm-в-docker-image\" style=\"position:relative;\"><a href=\"#%D0%BA%D0%BE%D0%BF%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8-php-fpm-%D0%B2-docker-image\" aria-label=\"копирование файла конфигурации php fpm в docker image permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Копирование файла конфигурации php-fpm в docker image</h4>\n<p>Настройки лежат в файле <code>php-fpm.conf</code>.\nНеобходимо пробросить этот файл в образ докера, если вы этого еще не сделали.\nДля этого создадим пустой файл <code>php-fpm.conf</code> и пропишем в <em>dockerfile</em> чтобы при сборке этот файл использовался в образе:</p>\n<pre><code class=\"language-dockerfile\">COPY ./php-fpm.conf /usr/local/etc/php-fpm.d/php-fpm.conf\n</code></pre>\n<p>Корректная директория внутри образа для этого файла варьируется от ОС и настроек системы.</p>\n<h4 id=\"активация-status-page-для-php-fpm\" style=\"position:relative;\"><a href=\"#%D0%B0%D0%BA%D1%82%D0%B8%D0%B2%D0%B0%D1%86%D0%B8%D1%8F-status-page-%D0%B4%D0%BB%D1%8F-php-fpm\" aria-label=\"активация status page для php fpm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Активация status page для php-fpm</h4>\n<p>Чтобы php-fpm отдавал ping page и status page, необходимо указать следующие значения в файле <code>php-fpm.conf</code>:</p>\n<pre><code class=\"language-ini\">ping.path=/ping\npm.status_path=/status\n</code></pre>\n<h3 id=\"nginx\" style=\"position:relative;\"><a href=\"#nginx\" aria-label=\"nginx permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nginx</h3>\n<p>Теперь нам необходимо научить nginx отдавать status и ping pages, которые мы настроили для php-fpm на предыдущем шаге</p>\n<p>Пропишем следующую секцию в настройках nginx:</p>\n<pre><code>server {\n    listen 81;\n    server_name &#x3C;DOCKER_SERVICE_NAME>;\n\n    access_log off;\n    \n    location ~ ^/(status|ping)$ {\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_index index.php;\n        include fastcgi_params;\n        fastcgi_pass &#x3C;FASTCGI_PASS>;\n    }\n}\n</code></pre>\n<p>Где нужно указать:</p>\n<ul>\n<li><code>DOCKER_SERVICE_NAME</code> — имя вашего <a href=\"/posts/create-docker-network-for-datadog#%D1%80%D0%B5%D0%B7%D0%BE%D0%BB%D0%B2%D0%B8%D0%BD%D0%B3-%D0%B2%D0%BD%D1%83%D1%82%D1%80%D0%B8-%D1%81%D0%B5%D1%82%D0%B8\">docker сервиса</a> (можно посмотреть в docker-compose.yaml или docker service ls)</li>\n<li><code>FASTCGI_PASS</code> — как вы обращаетесь <a href=\"http://nginx.org/ru/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass\">к php-fpm</a></li>\n</ul>\n<p>Я указал, чтобы nginx обрабатывал запросы по 81 порту, <a href=\"http://nginx.org/ru/docs/http/request_processing.html\">если мы обращаемся к нему</a> по SERVICE_NAME.\nЕсли 81 порт у вас занят — можно указать любой другой. </p>\n<p>При подобном обращении мы будем уверены, что получить доступ к служебным страницам php-fpm (status / ping) можно\nтолько из внутренней docker сети, которую мы создали в\n<a href=\"/posts/create-docker-network-for-datadog\">предыдущих статьях</a></p>\n<h3 id=\"сети\" style=\"position:relative;\"><a href=\"#%D1%81%D0%B5%D1%82%D0%B8\" aria-label=\"сети permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Сети</h3>\n<p>Убедимся, что контейнеры с <em>nginx</em>, <em>php-fpm</em> и <em>datadog</em> <a href=\"/posts/connect-datadog-apm-to-docker-swarm#configuration\">подключены к служебной сети</a>.\nДля этого стоит проверить, чтобы в списке <em>networks</em> была указана сеть <code>datadog-agent</code> (либо любая другая, которую вы\nиспользуете для внутренней коммуникации между сервисами):</p>\n<pre><code class=\"language-yaml\">services:\n...\n  service_name:\n    networks:\n      ...\n      - datadog-agent\n    ...\n</code></pre>\n<h2 id=\"проверим\" style=\"position:relative;\"><a href=\"#%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%B8%D0%BC\" aria-label=\"проверим permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Проверим</h2>\n<p>После того, как мы пересоберем и развернем контейнеры, можно проверить вручную, что всё работает так, как мы и хотели.\nДля этого зайдем в какой-нибудь контейнер, находящийся в одной docker-сети с контейнером php-fpm и попробуем обратиться\nк служебным страницам.\nЕсли мы руководствовались предыдущими статьями этой серии, то у вас должен быть настроен контейнер <code>agent</code> в котором\nнаходится datadog-agent.\nПредположим, что имя сервиса, в котором у вас развернут nginx является <code>web-server</code>, тогда команда будет выглядеть так:</p>\n<pre><code class=\"language-bash\">docker exec -it $(docker ps -q --filter \"name=agent\") curl web-server:81/status\n</code></pre>\n<p>в результате получим статус php-fpm. Будет выглядеть примерно так:</p>\n<pre><code>pool:                 www\nprocess manager:      dynamic\nstart time:           29/Aug/2020:12:00:00 +0300\nstart since:          2284\naccepted conn:        220\nlisten queue:         0\nmax listen queue:     0\nlisten queue len:     128\nidle processes:       5\nactive processes:     1\ntotal processes:      6\nmax active processes: 2\nmax children reached: 0\nslow requests:        0\n</code></pre>\n<p>Информацию о данных метриках можно посмотреть например, <a href=\"https://www.malasuk.com/linux/php-fpm-status-page/\">здесь</a>.</p>\n<h2 id=\"настройка-datadog-agent\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-datadog-agent\" aria-label=\"настройка datadog agent permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка datadog-agent</h2>\n<p>Приведём описание datadog-agent’а в <code>docker-compose.yaml</code> файле к подобному виду:</p>\n<pre><code>  agent:\n    image: \"datadog/agent:6.10.2\"\n    environment:\n      - DD_API_KEY=${DD_API_KEY}\n      - DD_APM_ENABLED=true\n      - DD_APM_NON_LOCAL_TRAFFIC=true\n      - DD_TAGS='env:your-tags'\n      - DD_LOGS_ENABLED=true\n      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - /proc/:/host/proc/:ro\n      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro\n    networks:\n      - datadog-agent\n    labels:\n      com.datadoghq.ad.check_names: '[\"php_fpm\"]'\n      com.datadoghq.ad.init_configs: '[{}]'\n      com.datadoghq.ad.instances: '[{\"status_url\":\"http://${SERVICE_NAME}:81/status\", \"ping_url\":\"http://${SERVICE_NAME}:81/ping\", \"use_fastcgi\": false, \"ping_reply\": \"pong\"}]'\n</code></pre>\n<p>Необходимо указать <code>${SERVICE_NAME}</code> — имя сервиса, в котором у нас развёрнут nginx. По этому пути datadog будет ходить\nза обновлением метрик, поэтому из контейнера <code>agent</code> по этим путям должен быть доступны наши служебные страницы.</p>\n<p>Также обратите внимание на 81 порт — если вы указали другой на предыдущем шаге, укажите здесь соответствующее значение.  </p>\n<p>Здесь мы добавили описание сервиса <code>php_fpm</code> в разделе <em>labels</em>.\nВ экосистеме datadog это называется <a href=\"https://docs.datadoghq.com/agent/docker/integrations/?tab=docker\">Integrations Autodiscovery</a>.</p>\n<h2 id=\"метрики\" style=\"position:relative;\"><a href=\"#%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA%D0%B8\" aria-label=\"метрики permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Метрики</h2>\n<p>Пересоберём и развернём наши контейнеры.</p>\n<p>Посмотрим доступные метрики. Перейдём в Datadog > Metrics > Explorer и начнём вводить <code>php_fpm</code>.\nМы должны увидеть что-то подобное:</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/datadog-php-fpm-metrics.png\" alt=\"Docker php-fpm Metrics\" title=\"Docker php-fpm Metrics\"></p>\n<p>Их краткое описание можно найти на странице с интеграцией php-fpm:</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/datadog-php-fpm-available-metrics.png\" alt=\"Docker php-fpm Available Metrics\" title=\"Docker php-fpm Available Metrics\"></p>\n<p>Если метрики появились, значит мы всё сделали правильно: docker-agent успешно собрал их из служебных страниц и отправил на сервер.</p>\n<h1 id=\"настройка-интеграции-nginx\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8-nginx\" aria-label=\"настройка интеграции nginx permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка интеграции nginx</h1>\n<p>Метрики nginx собираются при помощи модуля <a href=\"http://nginx.org/ru/docs/http/ngx_http_stub_status_module.html\"><code>http_stub_status_module</code></a>.</p>\n<p>В основных docker-образах nginx он уже присутствует поэтому дополнительных действий предпринимать не нужно.</p>\n<p>Интеграция nginx похожа на интеграцию php-fpm поэтому часть деталей опущу, чтобы не повторяться.</p>\n<h2 id=\"интеграция-datadog-1\" style=\"position:relative;\"><a href=\"#%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D1%8F-datadog-1\" aria-label=\"интеграция datadog 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Интеграция Datadog</h2>\n<p>Убедимся, что интеграция nginx включена в datadog:</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/datadog-nginx-integration.png\" alt=\"Datadog nginx Integration\" title=\"Datadog nginx Integration\"></p>\n<h2 id=\"настройка-контейнеров-1\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D0%BA%D0%BE%D0%BD%D1%82%D0%B5%D0%B9%D0%BD%D0%B5%D1%80%D0%BE%D0%B2-1\" aria-label=\"настройка контейнеров 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка контейнеров</h2>\n<h3 id=\"nginx-1\" style=\"position:relative;\"><a href=\"#nginx-1\" aria-label=\"nginx 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>nginx</h3>\n<p>Пропишем следующую секцию в настройках nginx, чтобы попросить его отдавать информацию о статусе по определенному endpoint’у:</p>\n<pre><code>server {\n    listen 82;\n    server_name &#x3C;DOCKER_SERVICE_NAME>;\n\n    access_log off;\n\n    location /nginx_status {\n        stub_status;\n        server_tokens on;\n    } \n}\n</code></pre>\n<p>Пример отдаваемой на странице информации:</p>\n<pre><code>Active connections: 291 \nserver accepts handled requests\n 16630948 16630948 31070465 \nReading: 6 Writing: 179 Waiting: 106 \n</code></pre>\n<h2 id=\"настройка-datadog-agent-1\" style=\"position:relative;\"><a href=\"#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-datadog-agent-1\" aria-label=\"настройка datadog agent 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Настройка datadog-agent</h2>\n<p>В настройках интеграции datadog необходимо указать </p>\n<pre><code class=\"language-yaml\">    com.datadoghq.ad.check_names: '[\"php_fpm\", \"nginx\"]'\n    com.datadoghq.ad.init_configs: '[{}, {}]'\n    com.datadoghq.ad.instances: '[{\"nginx_status_url\": \"http://${SERVICE_NAME}:82/nginx_status/\"}]'\n</code></pre>\n<p>Чтобы указать, откуда брать метрики для nginx.\nВ итоге, секция datadog-agent, вместе с предыдущими настройками, должна выглядеть примерно так:</p>\n<pre><code class=\"language-yaml\">  agent:\n    image: \"datadog/agent:6.10.2\"\n    environment:\n      - DD_API_KEY=${DD_API_KEY}\n      - DD_APM_ENABLED=true\n      - DD_APM_NON_LOCAL_TRAFFIC=true\n      - DD_TAGS='env:your-tags'\n      - DD_LOGS_ENABLED=true\n      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true\n    volumes:\n      - /var/run/docker.sock:/var/run/docker.sock:ro\n      - /proc/:/host/proc/:ro\n      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro\n    networks:\n      - datadog-agent\n    labels:\n      com.datadoghq.ad.check_names: '[\"php_fpm\", \"nginx\"]'\n      com.datadoghq.ad.init_configs: '[{}, {}]'\n      com.datadoghq.ad.instances: '[{\"status_url\":\"http://${SERVICE_NAME}:81/status\", \"ping_url\":\"http://${SERVICE_NAME}:81/ping\", \"use_fastcgi\": false, \"ping_reply\": \"pong\"}, {\"nginx_status_url\": \"http://${SERVICE_NAME}:82/nginx_status/\"}]'\n</code></pre>\n<h2 id=\"метрики-1\" style=\"position:relative;\"><a href=\"#%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA%D0%B8-1\" aria-label=\"метрики 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Метрики</h2>\n<p>После пересборки контейнеров, в datadog мы должны увидеть такие доступные метрики для nginx:</p>\n<p><img src=\"/media/2020-08-29-docker-swarm-php-fpm-nginx-metrics/datadog-nginx-metrics.png\" alt=\"Datadog nginx Metrics\" title=\"Datadog nginx Metrics\"></p>\n<hr>\n<p>Предыдущая статья <a href=\"/posts/connect-datadog-apm-to-docker-swarm\">Настраиваем Datadog APM в сети Docker Swarm</a></p>\n<p>Следующая статья <a href=\"/posts/datadog-monitor-slack-notifications\">Мониторим метрики при помощи Datadog Monitor и отправляем нотификации в Slack при возникновении проблем</a></p>","fields":{"slug":"/posts/docker-swarm-php-fpm-nginx-metrics","tagSlugs":["/tag/datadog","/tag/devops","/tag/ubuntu","/tag/php","/tag/php-fpm","/tag/nginx","/tag/infrastructure","/tag/docker","/tag/docker swarm"],"categorySlug":"/category/recipes"},"frontmatter":{"date":"2020-08-29T21:35:00.000Z","description":"Научимся собирать метрики php-fpm и nginx, на основе status page при помощи Datadog в сети Docker Swarm ","category":"recipes","tags":["datadog","devops","ubuntu","php","php-fpm","nginx","infrastructure","docker","docker swarm"],"title":"Собираем метрики php-fpm и nginx при помощи Datadog в сети Docker Swarm"}}},"pageContext":{"slug":"/posts/docker-swarm-php-fpm-nginx-metrics","allCategories":[{"fieldValue":"development","totalCount":3,"categoryColor":"pink-600"},{"fieldValue":"recipes","totalCount":5,"categoryColor":"green-600"}]}},"staticQueryHashes":["2052939023","251939775","401334301"]}