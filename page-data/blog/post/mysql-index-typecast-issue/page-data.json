{"componentChunkName":"component---src-templates-post-template-js","path":"/blog/post/mysql-index-typecast-issue","result":{"data":{"markdownRemark":{"id":"00b7f8e1-bc34-5b69-b5b8-b2b9e9d09052","html":"<h4 id=\"mysql-не-использует-индекс-поля-varchar-если-искать-в-нём-значение-в-виде-числа-однако-значение-будет-найдено-если-оно-есть-в-таблице\" style=\"position:relative;\"><a href=\"#mysql-%D0%BD%D0%B5-%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82-%D0%B8%D0%BD%D0%B4%D0%B5%D0%BA%D1%81-%D0%BF%D0%BE%D0%BB%D1%8F-varchar-%D0%B5%D1%81%D0%BB%D0%B8-%D0%B8%D1%81%D0%BA%D0%B0%D1%82%D1%8C-%D0%B2-%D0%BD%D1%91%D0%BC-%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2-%D0%B2%D0%B8%D0%B4%D0%B5-%D1%87%D0%B8%D1%81%D0%BB%D0%B0-%D0%BE%D0%B4%D0%BD%D0%B0%D0%BA%D0%BE-%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B1%D1%83%D0%B4%D0%B5%D1%82-%D0%BD%D0%B0%D0%B9%D0%B4%D0%B5%D0%BD%D0%BE-%D0%B5%D1%81%D0%BB%D0%B8-%D0%BE%D0%BD%D0%BE-%D0%B5%D1%81%D1%82%D1%8C-%D0%B2-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D0%B5\" aria-label=\"mysql не использует индекс поля varchar если искать в нём значение в виде числа однако значение будет найдено если оно есть в таблице permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MySQL не использует индекс поля varchar, если искать в нём значение в виде числа. Однако значение будет найдено, если оно есть в таблице</h4>\n<hr>\n<p><img src=\"/media/common/debug.jpg\" alt=\"Debug\" title=\"Debug\"></p>\n<h2 id=\"проблема\" style=\"position:relative;\"><a href=\"#%D0%BF%D1%80%D0%BE%D0%B1%D0%BB%D0%B5%D0%BC%D0%B0\" aria-label=\"проблема permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Проблема</h2>\n<p>Допустим, мы используем MySQL 8.0, в которой у нас есть столбец типа varchar с индексом UNIQUE.</p>\n<p>Если, по какой-либо причине в нём находится значение состоящее полностью из цифр и мы собираемся\nискать значение как число, то индекс применён не будет.</p>\n<p>Несмотря на то, что современные фреймворки не допустят такую ошибку, всё же наступить на эти\nграбли можно, если вводить запрос вручную. Особенно, если мы заранее ищем число, представленное в БД в виде\nvarchar — возможен человеческий фактор.</p>\n<p>На больших таблицах забытые кавычки в запросе грозят ненужной нагрузкой на базу</p>\n<h2 id=\"пример\" style=\"position:relative;\"><a href=\"#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80\" aria-label=\"пример permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Пример</h2>\n<p>Повторим проблему. Для этого склонируем этот\n<a href=\"https://github.com/mabalashov/mysql-test-dump\">репозиторий</a>,\nзапустим контейнер и накатим тестовый дамп данных:</p>\n<pre><code class=\"language-bash\">docker-compose up -d\ndocker exec -i fake-db sh -c 'exec mysql -uroot -proot' &#x3C; ./dump-unique-varchar.sql\n</code></pre>\n<p>или просто развернём <a href=\"https://github.com/mabalashov/mysql-test-dump/blob/master/dump-unique-varchar.sql\">дамп</a>\nв удобное место</p>\n<p>Сделаем EXPLAIN поиска по строке и попытаемся найти какое-нибудь значение:</p>\n<pre><code class=\"language-mysql\">EXPLAIN SELECT * FROM fakes WHERE name = '1703420';\n</code></pre>\n<p><img src=\"/media/2020-12-08-mysql-index-typecast-issue/with-index.png\" alt=\"With index\" title=\"with-index\"></p>\n<p>Теперь сделаем то же самое, только искать будем то же значение в виде числа:</p>\n<pre><code class=\"language-mysql\">EXPLAIN SELECT * FROM fakes WHERE name = 1703420;\n</code></pre>\n<p>Обнаружим, что несмотря на <code>Using index</code> mysql обошёл всю таблицу <code>rows=1000</code>:</p>\n<p><img src=\"/media/2020-12-08-mysql-index-typecast-issue/without-index.png\" alt=\"Without index\" title=\"without-index\"></p>\n<h2 id=\"bug-report\" style=\"position:relative;\"><a href=\"#bug-report\" aria-label=\"bug report permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bug Report</h2>\n<p>Команда MySQL не считает данное поведение <a href=\"https://bugs.mysql.com/bug.php?id=101883&#x26;thanks=sub\">багом</a></p>\n<p>С одной стороны, при сравнении искомого значения тип будет неявно приведен и логично было бы приводить тип и перед\nприменением индекса. С другой стороны, строковые и числовые индексы работают совершенно по разному и не стоит лишний\nраз угадывать за пользователя что он имел в виду</p>","fields":{"slug":"/posts/mysql-index-typecast-issue","tagSlugs":["/tag/mysql","/tag/database","/tag/indexes"],"categorySlug":"/category/debug"},"frontmatter":{"date":"2020-12-08T21:35:00.000Z","description":"MySQL не использует индекс поля varchar, если искать в нём значение е в виде числа. Однако значение будет найдено, если оно есть в таблице","category":"debug","tags":["mysql","database","indexes"],"title":"MySQL не использует индекс при неверном типе значения в WHERE"}}},"pageContext":{"slug":"/posts/mysql-index-typecast-issue","allCategories":[{"fieldValue":"debug","totalCount":1,"categoryColor":"pink-600"},{"fieldValue":"development","totalCount":3,"categoryColor":"green-600"},{"fieldValue":"recipes","totalCount":6,"categoryColor":"indigo-600"}]}},"staticQueryHashes":["2052939023","251939775","401334301"]}